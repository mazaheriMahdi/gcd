<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Argo Lite - Add Sync Target</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-10">Go Argo Lite - Add New Sync Target</h1>

        <div id="status-message" class="mb-6 p-4 rounded-md text-sm" style="display: none;"></div>

        <section class="max-w-4xl p-6 mx-auto bg-white rounded-md shadow-md">
            <form id="addSyncTargetForm">
                <div class="grid grid-cols-1 gap-6 mt-4 sm:grid-cols-2">
                    <div>
                        <label class="text-gray-700" for="repoURL">Repository URL</label>
                        <input id="repoURL" name="repoURL" type="text" required
                            class="block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-200 rounded-md focus:border-blue-400 focus:ring-blue-300 focus:ring-opacity-40 focus:outline-none focus:ring">
                    </div>

                    <div>
                        <label class="text-gray-700" for="repoBranch">Repository Branch</label>
                        <input id="repoBranch" name="repoBranch" type="text" required
                            class="block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-200 rounded-md focus:border-blue-400 focus:ring-blue-300 focus:ring-opacity-40 focus:outline-none focus:ring">
                    </div>

                    <div>
                        <label class="text-gray-700" for="manifestPath">Manifest Path in Repo</label>
                        <input id="manifestPath" name="manifestPath" type="text" placeholder="e.g., manifests/prod or k8s/overlays" required
                            class="block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-200 rounded-md focus:border-blue-400 focus:ring-blue-300 focus:ring-opacity-40 focus:outline-none focus:ring">
                    </div>

                    <div>
                        <label class="text-gray-700" for="pollIntervalSeconds">Poll Interval (seconds)</label>
                        <input id="pollIntervalSeconds" name="pollIntervalSeconds" type="number" value="60" required
                            class="block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-200 rounded-md focus:border-blue-400 focus:ring-blue-300 focus:ring-opacity-40 focus:outline-none focus:ring">
                    </div>

                    <div class="sm:col-span-2">
                        <label class="text-gray-700" for="gitCredentials">Git Credentials (optional)</label>
                        <input id="gitCredentials" name="gitCredentials" type="text" placeholder="e.g., <username>:<token> or leave blank for public repos"
                            class="block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-200 rounded-md focus:border-blue-400 focus:ring-blue-300 focus:ring-opacity-40 focus:outline-none focus:ring">
                        <p class="mt-1 text-xs text-gray-500">Note: For token auth, ensure your Git server supports it. Handle credentials securely.</p>
                    </div>

                    <div class="sm:col-span-2">
                        <label class="text-gray-700" for="kubeConfigContent">KubeConfig Content (YAML)</label>
                        <textarea id="kubeConfigContent" name="kubeConfigContent" rows="10" required
                            class="block w-full px-4 py-2 mt-2 text-gray-700 bg-white border border-gray-200 rounded-md focus:border-blue-400 focus:ring-blue-300 focus:ring-opacity-40 focus:outline-none focus:ring"></textarea>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="submit"
                        class="px-8 py-2.5 leading-5 text-white transition-colors duration-300 transform bg-blue-600 rounded-md hover:bg-blue-500 focus:outline-none focus:bg-blue-500">
                        Add Sync Target
                    </button>
                </div>
            </form>
        </section>
    </div>

    <script>
        const form = document.getElementById('addSyncTargetForm');
        const statusMessageDiv = document.getElementById('status-message');

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            statusMessageDiv.style.display = 'none';
            statusMessageDiv.textContent = '';

            const formData = new FormData(form);
            const syncTarget = {
                // ID will be generated by the server
                repoURL: formData.get('repoURL'),
                repoBranch: formData.get('repoBranch'),
                kubeConfigContent: formData.get('kubeConfigContent'),
                pollIntervalSeconds: parseInt(formData.get('pollIntervalSeconds'), 10) || 60,
                gitCredentials: formData.get('gitCredentials') || "", // Send empty string if not provided
                manifestPath: formData.get('manifestPath')
            };

            // Basic client-side validation (though server validation is key)
            if (!syncTarget.repoURL || !syncTarget.repoBranch || !syncTarget.kubeConfigContent || !syncTarget.manifestPath) {
                showStatus('Please fill in all required fields.', false);
                return;
            }
            if (syncTarget.pollIntervalSeconds <= 0) {
                showStatus('Poll Interval Seconds must be a positive number.', false);
                return;
            }

            try {
                const response = await fetch('/sync-targets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(syncTarget),
                });

                const responseData = await response.json();

                if (response.ok) { // Typically 200-299
                    showStatus(`SyncTarget created successfully! ID: ${responseData.id}`, true);
                    form.reset(); // Clear the form
                } else {
                    let errorMessage = `Error: ${response.status} ${response.statusText}`;
                    if (responseData && responseData.error) { // Assuming server sends { "error": "message" }
                        errorMessage = responseData.error;
                    } else if (typeof responseData === 'string') { // Sometimes error is plain text
                        errorMessage = responseData;
                    }
                     else if (responseData && responseData.message) { // if server sends { "message": "..." } for error
                        errorMessage = responseData.message;
                    }
                    showStatus(errorMessage, false);
                }
            } catch (error) {
                console.error('Submission error:', error);
                showStatus('An unexpected error occurred. Check the console.', false);
            }
        });

        function showStatus(message, isSuccess) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `mb-6 p-4 rounded-md text-sm ${isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            statusMessageDiv.style.display = 'block';
        }
    </script>
</body>
</html>
